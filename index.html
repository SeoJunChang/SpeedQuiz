<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Crossword">
    <meta name="theme-color" content="#0f172a">
    <title>Crossword Challenge</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        :root{--bg:#0f172a;--bg2:#1e293b;--bg3:#334155;--text:#f8fafc;--text2:#94a3b8;--accent:#3b82f6;--success:#22c55e;--error:#ef4444;--gold:#fbbf24}
        html,body{height:100%;overflow:hidden;touch-action:manipulation}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text)}
        .app{height:100%;display:flex;flex-direction:column;padding:env(safe-area-inset-top) env(safe-area-inset-right) 0 env(safe-area-inset-left)}
        header{padding:12px 16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--bg3);flex-shrink:0}
        .logo{font-size:18px;font-weight:700;letter-spacing:1px}
        .round{font-size:14px;color:var(--accent);font-weight:700;margin-top:2px}
        .stats{display:flex;gap:12px;font-size:15px;color:var(--text2);align-items:center;font-weight:600}
        .score-box{display:flex;gap:8px;align-items:center}
        .score{color:var(--gold);font-weight:700;font-size:16px}
        .best{color:var(--text2);font-size:12px}
        .time-warn{color:var(--error) !important;animation:blink 1s infinite}
        @keyframes blink{50%{opacity:0.5}}
        main{flex:1;display:flex;flex-direction:column;overflow:hidden;padding:8px;min-height:0}
        .clue-box{background:var(--bg2);border-radius:10px;padding:10px 12px;margin-bottom:8px;flex-shrink:0}
        .clue-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
        .clue-num{font-size:11px;font-weight:600;color:#60a5fa;text-transform:uppercase}
        .dir-btn{font-size:10px;color:var(--text2);background:var(--bg3);padding:3px 8px;border-radius:12px;border:none}
        .clue-text{font-size:14px;line-height:1.3}
        .clue-kr{font-size:12px;color:var(--text2);margin-top:4px;display:none}
        .clue-kr.on{display:block}
        .clue-hint2{font-size:12px;color:var(--gold);margin-top:4px;display:none}
        .clue-hint2.on{display:block}
        .grid-wrap{flex:1;display:flex;justify-content:center;align-items:center;overflow:hidden;min-height:0}
        .grid{display:grid;gap:2px;background:var(--bg3);padding:2px;border-radius:6px}
        .cell{background:#fff;position:relative;display:flex;align-items:center;justify-content:center;border-radius:2px;user-select:none}
        .cell.black{background:var(--bg)}
        .cell .n{position:absolute;top:1px;left:2px;font-size:7px;font-weight:600;color:#64748b}
        .cell .l{font-size:14px;font-weight:600;color:#1e293b;text-transform:uppercase}
        .cell.sel{background:#fef08a !important;box-shadow:inset 0 0 0 2px var(--accent)}
        .cell.hl{background:#e0f2fe}
        .cell.ok{background:#dcfce7 !important}
        .cell.ok .l{color:var(--success)}
        .cell.err{background:#fee2e2 !important}
        .cell.err .l{color:var(--error)}
        .cell.locked{opacity:0.8}
        .cell.locked::after{content:'';position:absolute;inset:0;background:rgba(34,197,94,0.15)}
        .controls{display:flex;gap:4px;padding:8px 0;flex-wrap:wrap;justify-content:center;flex-shrink:0}
        .btn{padding:8px 8px;border:none;border-radius:6px;font-size:11px;font-weight:500;background:var(--bg2);color:var(--text);position:relative}
        .btn:active{transform:scale(0.96);opacity:0.8}
        .btn.pri{background:var(--accent)}
        .btn.on{background:var(--success)}
        .btn:disabled{opacity:0.4}
        .btn .cost{font-size:9px;color:var(--gold);display:block;margin-top:1px}
        .keyboard{background:var(--bg2);padding:6px 4px;padding-bottom:calc(6px + env(safe-area-inset-bottom));flex-shrink:0}
        .kb-row{display:flex;justify-content:center;gap:4px;margin-bottom:4px}
        .kb-row:last-child{margin-bottom:0}
        .key{min-width:28px;height:40px;border:none;border-radius:5px;background:var(--bg3);color:var(--text);font-size:16px;font-weight:500;display:flex;align-items:center;justify-content:center;flex:1;max-width:36px}
        .key:active{background:var(--accent)}
        .key.wide{min-width:50px;max-width:60px;font-size:11px}
        .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);opacity:0;visibility:hidden;transition:all 0.3s;z-index:100}
        .overlay.on{opacity:1;visibility:visible}
        .panel{position:fixed;top:0;right:0;bottom:0;width:min(360px,85vw);background:var(--bg);transform:translateX(100%);transition:transform 0.3s;z-index:101;display:flex;flex-direction:column;padding-top:env(safe-area-inset-top)}
        .panel.on{transform:translateX(0)}
        .panel-head{padding:14px;border-bottom:1px solid var(--bg3);display:flex;justify-content:space-between;align-items:center}
        .panel-head h2{font-size:16px}
        .close-btn{width:32px;height:32px;border:none;border-radius:50%;background:var(--bg2);color:var(--text);font-size:18px}
        .panel-body{flex:1;overflow-y:auto;padding:14px}
        .setting{display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--bg2);border-radius:8px;margin-bottom:14px}
        .toggle{width:44px;height:26px;background:var(--bg3);border-radius:13px;position:relative}
        .toggle.on{background:var(--success)}
        .toggle::after{content:'';position:absolute;width:20px;height:20px;background:white;border-radius:50%;top:3px;left:3px;transition:0.3s}
        .toggle.on::after{transform:translateX(18px)}
        .section{margin-bottom:20px}
        .section h3{font-size:11px;color:#60a5fa;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--bg3)}
        .item{padding:10px;background:var(--bg2);border-radius:6px;margin-bottom:6px;font-size:13px}
        .item.act{background:var(--bg3);border-left:3px solid var(--accent)}
        .item .num{font-weight:600;margin-right:6px}
        .item .txt{color:var(--text2)}
        .item .kr{display:block;font-size:11px;color:var(--text2);margin-top:3px;opacity:0.7}
        .item .kr.hide{display:none}
        .toast{position:fixed;bottom:200px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--bg3);padding:10px 20px;border-radius:20px;font-size:13px;opacity:0;visibility:hidden;transition:all 0.3s;z-index:200}
        .toast.on{opacity:1;visibility:visible;transform:translateX(-50%) translateY(0)}
        .toast.ok{background:var(--success)}
        .toast.warn{background:var(--error)}
        .loading{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;color:var(--text2)}
        .spin{width:36px;height:36px;border:3px solid var(--bg3);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .hint-popup{position:fixed;bottom:260px;left:50%;transform:translateX(-50%);background:var(--bg2);border:1px solid var(--gold);padding:12px 16px;border-radius:10px;z-index:150;max-width:280px;text-align:center;opacity:0;visibility:hidden;transition:all 0.3s}
        .hint-popup.on{opacity:1;visibility:visible}
        .hint-popup .label{font-size:10px;color:var(--gold);margin-bottom:4px}
        .hint-popup .content{font-size:14px}
        .gameover-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:300;display:flex;align-items:center;justify-content:center;opacity:0;visibility:hidden;transition:all 0.3s}
        .gameover-overlay.on{opacity:1;visibility:visible}
        .gameover-box{background:var(--bg2);border-radius:16px;padding:24px;text-align:center;max-width:320px;width:90%}
        .gameover-box h2{font-size:24px;margin-bottom:8px;color:var(--error)}
        .gameover-box .final-round{font-size:32px;font-weight:700;color:var(--gold);margin:16px 0}
        .gameover-box .final-score{font-size:14px;color:var(--text2);margin-bottom:8px}
        .gameover-box .best-record{font-size:12px;color:var(--text2);margin-bottom:20px;padding:10px;background:var(--bg3);border-radius:8px}
        .gameover-box .best-record span{color:var(--gold)}
        .gameover-btns{display:flex;gap:10px;justify-content:center}
        .gameover-btns button{padding:12px 20px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer}
        .gameover-btns .retry{background:var(--accent);color:white}
        .gameover-btns .share{background:var(--success);color:white}
        @media(min-width:768px){.app{max-width:1100px;margin:0 auto;padding-bottom:env(safe-area-inset-bottom)}header{padding:14px 20px}.logo{font-size:18px}main{flex-direction:row;gap:20px;padding:16px}.game{flex:1;display:flex;flex-direction:column}.keyboard{display:none !important}.desk-clues{width:280px;background:var(--bg2);border-radius:10px;padding:14px;overflow-y:auto}.desk-clues h3{font-size:11px;color:#60a5fa;text-transform:uppercase;margin-bottom:8px}.desk-clues .list{margin-bottom:14px}.desk-clues .item{padding:6px 8px;font-size:12px;background:var(--bg3);margin-bottom:3px}.desk-clues .item.act{background:var(--accent);color:white}.desk-clues .item.act .txt,.desk-clues .item.act .kr{color:rgba(255,255,255,0.9)}.cell{width:32px !important;height:32px !important}.cell .l{font-size:16px}.cell .n{font-size:8px}.btn.mob{display:none}.clue-box{display:none}.toast{bottom:100px}.hint-popup{bottom:150px}}
        @media(max-width:767px){.desk-clues{display:none}}
        @media(max-width:380px){.cell .l{font-size:12px}.cell .n{font-size:6px}.key{height:36px;font-size:14px}.btn{padding:6px 6px;font-size:10px}}
    </style>
</head>
<body>
    <div class="app" id="app">
        <header>
            <div>
                <div class="logo">CROSSWORD</div>
                <div class="round" id="roundDisp">Round 1</div>
            </div>
            <div class="stats">
                <span>‚è± <span id="time">00:00</span></span>
                <div class="score-box">
                    <span>üí∞ <span class="score" id="score">100</span></span>
                    <span class="best">üèÜ R<span id="bestRound">1</span></span>
                </div>
            </div>
        </header>
        <main id="main"><div class="loading"><div class="spin"></div><div>Generating...</div></div></main>
    </div>
    <div class="overlay" id="ov" onclick="hidePanel()"></div>
    <div class="panel" id="pn">
        <div class="panel-head"><h2>Clues</h2><button class="close-btn" onclick="hidePanel()">√ó</button></div>
        <div class="panel-body">
            <div class="setting"><span>ÌïúÍ∏Ä ÌûåÌä∏</span><div class="toggle" id="tgl" onclick="toggleKr()"></div></div>
            <div class="section"><h3>Across ‚Üí</h3><div id="acr"></div></div>
            <div class="section"><h3>Down ‚Üì</h3><div id="dwn"></div></div>
        </div>
    </div>
    <div class="toast" id="toast"></div>
    <div class="hint-popup" id="hintPopup"><div class="label">Ïâ¨Ïö¥ ÌûåÌä∏</div><div class="content" id="hintContent"></div></div>
    <div class="gameover-overlay" id="gameoverOverlay">
        <div class="gameover-box">
            <h2>‚ò†Ô∏è GAME OVER</h2>
            <div class="final-round">Round <span id="finalRound">1</span></div>
            <div class="final-score">ÏµúÏ¢Ö Ï†êÏàò: <span id="finalScore">0</span>Ï†ê</div>
            <div class="best-record">üèÜ ÏµúÍ≥† Í∏∞Î°ù: Round <span id="recordRound">1</span> / <span id="recordScore">100</span>Ï†ê</div>
            <div class="gameover-btns">
                <button class="retry" onclick="restartGame()">Îã§Ïãú ÎèÑÏ†Ñ</button>
                <button class="share" onclick="shareResult()">üì§ Í≥µÏú†</button>
            </div>
        </div>
    </div>
    <script src="words.js"></script>
    <script>
if(typeof WORDS==='undefined'){var WORDS=[{word:"CAT",clue:"Feline pet",kr:"Í≥†ÏñëÏûáÍ≥º Ïï†ÏôÑÎèôÎ¨º",hint2:"ÏïºÏòπ ÎèôÎ¨º",hint3:"Í≥†ÏñëÏù¥"},{word:"DOG",clue:"Man's best friend",kr:"Ïù∏Í∞ÑÏùò ÏπúÍµ¨",hint2:"Î©çÎ©ç ÎèôÎ¨º",hint3:"Í∞ú"},{word:"BOOK",clue:"Reading material",kr:"ÏùΩÏùÑÍ±∞Î¶¨",hint2:"Í∏ÄÏûêÍ∞Ä Ï†ÅÌûå Ï¢ÖÏù¥ Î¨∂Ïùå",hint3:"Ï±Ö"},{word:"FISH",clue:"Aquatic animal",kr:"ÏàòÏ§ë ÎèôÎ¨º",hint2:"Î¨ºÏóêÏÑú ÏÇ¨Îäî ÎèôÎ¨º",hint3:"Î¨ºÍ≥†Í∏∞"},{word:"MOON",clue:"Earth's satellite",kr:"ÏßÄÍµ¨Ïùò ÏúÑÏÑ±",hint2:"Î∞§ÌïòÎäòÏóê Îú®Îäî Í≤É",hint3:"Îã¨"},{word:"STAR",clue:"Celestial body",kr:"Ï≤úÏ≤¥",hint2:"Î∞§ÌïòÎäòÏóê Î∞òÏßùÏù¥Îäî Í≤É",hint3:"Î≥Ñ"},{word:"TREE",clue:"Tall plant",kr:"ÌÇ§Í∞Ä ÌÅ∞ ÏãùÎ¨º",hint2:"Ïà≤ÏùÑ Ïù¥Î£®Îäî Í≤É",hint3:"ÎÇòÎ¨¥"},{word:"APPLE",clue:"Red or green fruit",kr:"Îπ®Í∞ï/ÎÖπÏÉâ Í≥ºÏùº",hint2:"ÏïÑÏÇ≠Ìïú Í≥ºÏùº",hint3:"ÏÇ¨Í≥º"},{word:"WATER",clue:"H2O",kr:"H2O",hint2:"ÎßàÏãúÎäî Ïï°Ï≤¥",hint3:"Î¨º"}]}

let SIZE=11,grid=[],user=[],placed=[],cur=null,dir='across';
let tmr=null,sec=0,krOn=false,locked=[];
let score=100,round=1;
let bestRound=1,bestScore=100;
let desk=window.innerWidth>=768;
let hint2Shown={},revealedWords={},wordScored={};
let gameOver=false,timePenaltyStarted=false;

const SCORE={letterCorrect:1,letterWrong:-1,wordComplete:2,puzzleClear:10,hintEasy:8,hintRandom:15,hintAnswer:40,skipPenalty:20};
const TIME_PENALTY_START=180; // 3Î∂Ñ = 180Ï¥à
const TIME_PENALTY_INTERVAL=10; // 10Ï¥àÎßàÎã§
const TIME_PENALTY_AMOUNT=1; // -1Ï†ê

function init(){
    loadBestRecord();
    gen();
    regSW();
    setupKeyboard();
    window.addEventListener('resize',()=>{const was=desk;desk=window.innerWidth>=768;if(was!==desk&&grid.length)render()})
}

function regSW(){if('serviceWorker' in navigator)navigator.serviceWorker.register('sw.js').catch(()=>{})}

function loadBestRecord(){
    const saved=localStorage.getItem('crossword_best');
    if(saved){
        const data=JSON.parse(saved);
        bestRound=data.round||1;
        bestScore=data.score||100;
    }
    updateBestDisplay();
}

function saveBestRecord(){
    if(round>bestRound||(round===bestRound&&score>bestScore)){
        bestRound=round;
        bestScore=score;
        localStorage.setItem('crossword_best',JSON.stringify({round:bestRound,score:bestScore}));
    }
    updateBestDisplay();
}

function updateBestDisplay(){
    const el=document.getElementById('bestRound');
    if(el)el.textContent=bestRound;
}

function setupKeyboard(){
    document.addEventListener('keydown',e=>{
        if(gameOver)return;
        if(!desk)return;
        if(e.key==='Enter'){e.preventDefault();chk();return}
        if(e.key==='Tab'){e.preventDefault();togDir();return}
        if(e.key.length===1&&e.key.match(/[a-zA-Z]/)&&cur&&!isLocked(cur.r,cur.c)){e.preventDefault();setLetter(cur.r,cur.c,e.key.toUpperCase());nextUnfilled()}
        else if(e.key==='Backspace'&&cur){e.preventDefault();if(user[cur.r][cur.c]&&!isLocked(cur.r,cur.c))setLetter(cur.r,cur.c,'');else{prevUnlocked();if(cur&&!isLocked(cur.r,cur.c))setLetter(cur.r,cur.c,'')}}
        else if(e.key==='ArrowUp'){e.preventDefault();moveBy(-1,0)}
        else if(e.key==='ArrowDown'){e.preventDefault();moveBy(1,0)}
        else if(e.key==='ArrowLeft'){e.preventDefault();moveBy(0,-1)}
        else if(e.key==='ArrowRight'){e.preventDefault();moveBy(0,1)}
    })
}

function isLocked(r,c){return locked.some(l=>l.r===r&&l.c===c)}

function updateScore(delta){
    score+=delta;
    if(score<=0){
        score=0;
        document.getElementById('score').textContent=score;
        triggerGameOver();
        return;
    }
    document.getElementById('score').textContent=score;
    saveBestRecord();
    updateHintButtons();
}

function triggerGameOver(){
    gameOver=true;
    stopTmr();
    saveBestRecord();
    document.getElementById('finalRound').textContent=round;
    document.getElementById('finalScore').textContent=score;
    document.getElementById('recordRound').textContent=bestRound;
    document.getElementById('recordScore').textContent=bestScore;
    document.getElementById('gameoverOverlay').classList.add('on');
}

function restartGame(){
    // Í≤åÏûÑÏò§Î≤Ñ ÏÉÅÌÉúÍ∞Ä ÏïÑÎãàÎ©¥ ÌôïÏù∏ Î¨ªÍ∏∞
    if(!gameOver&&(round>1||score<100)){
        if(!confirm('ÌòÑÏû¨ ÏßÑÌñâ ÏÉÅÌô©ÏùÑ Ìè¨Í∏∞ÌïòÍ≥†\nÏÉà Í≤åÏûÑÏùÑ ÏãúÏûëÌï†ÍπåÏöî?\n\nüèÅ Round '+round+'\nüí∞ Score: '+score+'Ï†ê')){
            return;
        }
    }
    document.getElementById('gameoverOverlay').classList.remove('on');
    gameOver=false;
    score=100;
    round=1;
    document.getElementById('score').textContent=score;
    document.getElementById('roundDisp').textContent='Round '+round;
    gen();
}

function skipRound(){
    if(gameOver)return;
    // ÏôÑÎ£å Ïïà ÌïòÍ≥† Ïä§ÌÇµÌïòÎ©¥ Ìå®ÎÑêÌã∞
    updateScore(-SCORE.skipPenalty);
    if(score<=0)return; // Í≤åÏûÑÏò§Î≤Ñ Ï≤¥ÌÅ¨
    toast('‚è≠Ô∏è Ïä§ÌÇµ! -'+SCORE.skipPenalty+'Ï†ê',false,true);
    setTimeout(()=>{
        round++;
        saveBestRecord();
        gen();
    },500);
}

function shareResult(){
    const text=`üß© Crossword Challenge
‚ò†Ô∏è Game Over!

üèÅ Round ${round}
üí∞ Score: ${score}Ï†ê
üèÜ Best: Round ${bestRound}

ÎèÑÏ†ÑÌï¥Î≥¥ÏÑ∏Ïöî!`;

    if(navigator.share){
        navigator.share({title:'Crossword Challenge',text:text}).catch(()=>copyToClipboard(text));
    }else{
        copyToClipboard(text);
    }
}

function copyToClipboard(text){
    navigator.clipboard.writeText(text).then(()=>{
        toast('üìã Í≤∞Í≥ºÍ∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!',true);
    }).catch(()=>{
        toast('Î≥µÏÇ¨ Ïã§Ìå®',false,true);
    });
}

function updateHintButtons(){
    const h1=document.getElementById('hint1Btn'),h2=document.getElementById('hint2Btn'),h3=document.getElementById('hint3Btn');
    if(h1)h1.disabled=score<SCORE.hintRandom;
    if(h2)h2.disabled=score<SCORE.hintEasy;
    if(h3)h3.disabled=score<SCORE.hintAnswer;
}

function gen(){
    if(gameOver)return;
    showLoad();
    hint2Shown={};revealedWords={};wordScored={};
    timePenaltyStarted=false;
    setTimeout(()=>{
        let best=null,bp=[];
        for(let i=0;i<5;i++){const r=mkGrid();if(r.p.length>bp.length){best=r.g;bp=r.p}}
        grid=best;placed=bp;
        user=Array(SIZE).fill(null).map(()=>Array(SIZE).fill(''));
        locked=[];assignNum();render();sec=0;startTmr();
        document.getElementById('roundDisp').textContent='Round '+round;
    },100)
}

function nextRound(){
    round++;
    saveBestRecord();
    gen();
}

function mkGrid(){
    const g=Array(SIZE).fill(null).map(()=>Array(SIZE).fill(null)),p=[];
    const sh=[...WORDS].sort(()=>Math.random()-0.5).sort((a,b)=>b.word.length-a.word.length);
    const f=sh.find(w=>w.word.length<=SIZE-2);
    if(f){const r=Math.floor(SIZE/2),c=Math.floor((SIZE-f.word.length)/2);for(let i=0;i<f.word.length;i++)g[r][c+i]=f.word[i];p.push({...f,row:r,col:c,dir:'across'})}
    let att=0;
    while(att<500&&p.length<15){
        att++;const w=sh[Math.floor(Math.random()*sh.length)];
        if(p.some(x=>x.word===w.word)||w.word.length>SIZE-2)continue;
        const pl=findPl(g,w.word,p);
        if(pl){for(let i=0;i<w.word.length;i++){if(pl.dir==='across')g[pl.row][pl.col+i]=w.word[i];else g[pl.row+i][pl.col]=w.word[i]}p.push({...w,...pl})}
    }
    return{g,p}
}

function findPl(g,word,p){
    const opts=[];
    for(let r=0;r<SIZE;r++)for(let c=0;c<SIZE;c++){
        if(!g[r][c])continue;
        for(let i=0;i<word.length;i++){
            if(word[i]!==g[r][c])continue;
            if(canPl(g,word,r,c-i,'across',p))opts.push({row:r,col:c-i,dir:'across'});
            if(canPl(g,word,r-i,c,'down',p))opts.push({row:r-i,col:c,dir:'down'})
        }
    }
    return opts.length?opts[Math.floor(Math.random()*opts.length)]:null
}

function canPl(g,word,sr,sc,d,p){
    const len=word.length;
    if(sr<0||sc<0)return false;
    if(d==='across'&&sc+len>SIZE)return false;
    if(d==='down'&&sr+len>SIZE)return false;
    if(d==='across'){if(sc>0&&g[sr][sc-1])return false;if(sc+len<SIZE&&g[sr][sc+len])return false}
    else{if(sr>0&&g[sr-1][sc])return false;if(sr+len<SIZE&&g[sr+len][sc])return false}
    let cross=0,conflict=false;
    for(let i=0;i<len;i++){
        const r=d==='across'?sr:sr+i,c=d==='across'?sc+i:sc;
        if(g[r][c]){if(g[r][c]===word[i])cross++;else conflict=true}
        else{
            if(d==='across'){if((r>0&&g[r-1][c])||(r<SIZE-1&&g[r+1][c]))conflict=true}
            else{if((c>0&&g[r][c-1])||(c<SIZE-1&&g[r][c+1]))conflict=true}
        }
    }
    return !conflict&&cross>=1
}

function assignNum(){placed.sort((a,b)=>a.row!==b.row?a.row-b.row:a.col-b.col);let n=1;const m={};placed.forEach(w=>{const k=w.row+'-'+w.col;if(!m[k])m[k]=n++;w.num=m[k]})}
function showLoad(){document.getElementById('main').innerHTML='<div class="loading"><div class="spin"></div><div>Generating...</div></div>'}

function render(){
    const oldKb=document.querySelector('.keyboard');if(oldKb)oldKb.remove();
    const cs=desk?32:Math.min(28,Math.floor((window.innerWidth-32)/SIZE));
    const nm={};placed.forEach(w=>{const k=w.row+'-'+w.col;if(!nm[k])nm[k]=w.num});
    let gh='';
    for(let r=0;r<SIZE;r++)for(let c=0;c<SIZE;c++){
        const bl=!grid[r][c],n=nm[r+'-'+c],lk=isLocked(r,c);
        gh+='<div class="cell '+(bl?'black ':' ')+(lk?'locked ok':'')+'" data-r="'+r+'" data-c="'+c+'" style="width:'+cs+'px;height:'+cs+'px">'+(n?'<span class="n">'+n+'</span>':'')+(!bl?'<span class="l" id="l-'+r+'-'+c+'">'+user[r][c]+'</span>':'')+'</div>'
    }
    const html='<div class="game"><div class="clue-box"><div class="clue-head"><span class="clue-num" id="cn">Select a cell</span><button class="dir-btn" onclick="togDir()">'+(dir==='across'?'‚Üí Across':'‚Üì Down')+'</button></div><div class="clue-text" id="ct"></div><div class="clue-kr '+(krOn?'on':'')+'" id="ck"></div><div class="clue-hint2" id="ch2"></div></div><div class="grid-wrap"><div class="grid" id="grid" style="grid-template-columns:repeat('+SIZE+','+cs+'px)">'+gh+'</div></div><div class="controls"><button class="btn pri" onclick="restartGame()">New</button><button class="btn" onclick="skipRound()">Next<span class="cost">-'+SCORE.skipPenalty+'</span></button><button class="btn" onclick="useHint2()" id="hint2Btn">üí°<span class="cost">-'+SCORE.hintEasy+'</span></button><button class="btn" onclick="useHint1()" id="hint1Btn">üîÄ<span class="cost">-'+SCORE.hintRandom+'</span></button><button class="btn" onclick="useHint3()" id="hint3Btn">üîì<span class="cost">-'+SCORE.hintAnswer+'</span></button><button class="btn" onclick="chk()">Check</button><button class="btn '+(krOn?'on':'')+'" onclick="togKrQ()" id="kb-btn">üá∞üá∑</button><button class="btn mob" onclick="showPanel()">Clues</button></div></div>'+(desk?'<div class="desk-clues"><div class="setting"><span>ÌïúÍ∏Ä ÌûåÌä∏</span><div class="toggle '+(krOn?'on':'')+'" onclick="togKrQ()"></div></div><h3>Across ‚Üí</h3><div class="list" id="da"></div><h3>Down ‚Üì</h3><div class="list" id="dd"></div></div>':'');
    document.getElementById('main').innerHTML=html;
    if(!desk){
        const kbHtml='<div class="keyboard"><div class="kb-row">'+['Q','W','E','R','T','Y','U','I','O','P'].map(k=>'<button class="key" data-key="'+k+'">'+k+'</button>').join('')+'</div><div class="kb-row">'+['A','S','D','F','G','H','J','K','L'].map(k=>'<button class="key" data-key="'+k+'">'+k+'</button>').join('')+'</div><div class="kb-row"><button class="key wide" data-key="DIR">‚ÜîÔ∏è</button>'+['Z','X','C','V','B','N','M'].map(k=>'<button class="key" data-key="'+k+'">'+k+'</button>').join('')+'<button class="key wide" data-key="DEL">‚å´</button></div><div class="kb-row"><button class="key wide" data-key="ENTER">CHECK ‚úì</button></div></div>';
        document.getElementById('app').insertAdjacentHTML('beforeend',kbHtml);
        setupMobileKeyboard()
    }
    document.querySelectorAll('.cell:not(.black)').forEach(cell=>{cell.addEventListener('click',()=>{cellClick(parseInt(cell.dataset.r),parseInt(cell.dataset.c))})});
    buildClues();updateHintButtons();if(cur)hl()
}

function setupMobileKeyboard(){
    document.querySelectorAll('.key').forEach(key=>{
        key.addEventListener('click',e=>{
            if(gameOver)return;
            e.preventDefault();const k=key.dataset.key;if(!cur)return;
            if(k==='DEL'){if(user[cur.r][cur.c]&&!isLocked(cur.r,cur.c))setLetter(cur.r,cur.c,'');else{prevUnlocked();if(cur&&!isLocked(cur.r,cur.c))setLetter(cur.r,cur.c,'')}}
            else if(k==='DIR'){togDir()}
            else if(k==='ENTER'){chk()}
            else if(!isLocked(cur.r,cur.c)){setLetter(cur.r,cur.c,k);nextUnfilled()}
        })
    })
}

function buildClues(){
    const ac=placed.filter(w=>w.dir==='across').sort((a,b)=>a.num-b.num);
    const dw=placed.filter(w=>w.dir==='down').sort((a,b)=>a.num-b.num);
    document.getElementById('acr').innerHTML=ac.map(w=>'<div class="item" data-n="'+w.num+'" data-d="across" onclick="selClue('+w.row+','+w.col+',\'across\')"><span class="num">'+w.num+'.</span><span class="txt">'+w.clue+'</span><span class="kr '+(krOn?'':'hide')+'">'+w.kr+'</span></div>').join('');
    document.getElementById('dwn').innerHTML=dw.map(w=>'<div class="item" data-n="'+w.num+'" data-d="down" onclick="selClue('+w.row+','+w.col+',\'down\')"><span class="num">'+w.num+'.</span><span class="txt">'+w.clue+'</span><span class="kr '+(krOn?'':'hide')+'">'+w.kr+'</span></div>').join('');
    if(desk){
        document.getElementById('da').innerHTML=ac.map(w=>'<div class="item" data-n="'+w.num+'" data-d="across" onclick="selClue('+w.row+','+w.col+',\'across\')"><span class="num">'+w.num+'.</span><span class="txt">'+w.clue+'</span><span class="kr '+(krOn?'':'hide')+'">'+w.kr+'</span></div>').join('');
        document.getElementById('dd').innerHTML=dw.map(w=>'<div class="item" data-n="'+w.num+'" data-d="down" onclick="selClue('+w.row+','+w.col+',\'down\')"><span class="num">'+w.num+'.</span><span class="txt">'+w.clue+'</span><span class="kr '+(krOn?'':'hide')+'">'+w.kr+'</span></div>').join('')
    }
}

function cellClick(r,c){if(gameOver)return;if(!grid[r][c])return;hideHintPopup();if(cur&&cur.r===r&&cur.c===c)togDir();else{cur={r,c};hl();updClue()}}
function selClue(r,c,d){if(gameOver)return;dir=d;cur={r,c};hl();updClue();hidePanel();hideHintPopup()}
function togDir(){if(!cur)return;dir=dir==='across'?'down':'across';hl();updClue();const b=document.querySelector('.dir-btn');if(b)b.textContent=dir==='across'?'‚Üí Across':'‚Üì Down'}
function setLetter(r,c,l){user[r][c]=l;const e=document.getElementById('l-'+r+'-'+c);if(e)e.textContent=l}

function nextUnfilled(){
    if(!cur)return;let{r,c}=cur;const cells=getWC(r,c);let idx=cells.findIndex(cell=>cell.r===r&&cell.c===c);
    for(let i=idx+1;i<cells.length;i++){const cell=cells[i];if(!user[cell.r][cell.c]&&!isLocked(cell.r,cell.c)){cur={r:cell.r,c:cell.c};hl();return}}
    nextWord()
}

function nextWord(){
    const cw=getCurWord();if(!cw)return;
    const same=placed.filter(w=>w.dir===dir).sort((a,b)=>a.num-b.num);
    const i=same.findIndex(w=>w.num===cw.num);const nw=same[i+1]||same[0];
    if(nw){
        const cells=[];
        for(let j=0;j<nw.word.length;j++){if(nw.dir==='across')cells.push({r:nw.row,c:nw.col+j});else cells.push({r:nw.row+j,c:nw.col})}
        for(const cell of cells){if(!user[cell.r][cell.c]&&!isLocked(cell.r,cell.c)){cur={r:cell.r,c:cell.c};hl();updClue();return}}
        cur={r:nw.row,c:nw.col};hl();updClue()
    }
}

function prevUnlocked(){
    if(!cur)return;let{r,c}=cur;const cells=getWC(r,c);let idx=cells.findIndex(cell=>cell.r===r&&cell.c===c);
    for(let i=idx-1;i>=0;i--){const cell=cells[i];if(!isLocked(cell.r,cell.c)){cur={r:cell.r,c:cell.c};hl();return}}
}

function moveBy(dr,dc){if(!cur)return;let r=cur.r+dr,c=cur.c+dc;if(r>=0&&r<SIZE&&c>=0&&c<SIZE&&grid[r][c]){cur={r,c};hl();updClue()}}

function hl(){
    document.querySelectorAll('.cell').forEach(e=>{e.classList.remove('sel','hl')});if(!cur)return;
    const cells=getWC(cur.r,cur.c);
    cells.forEach(({r,c})=>{const e=document.querySelector('.cell[data-r="'+r+'"][data-c="'+c+'"]');if(e&&!isLocked(r,c))e.classList.add('hl')});
    const s=document.querySelector('.cell[data-r="'+cur.r+'"][data-c="'+cur.c+'"]');if(s){s.classList.remove('hl');s.classList.add('sel')}
    document.querySelectorAll('.item').forEach(e=>e.classList.remove('act'));
    const w=getCurWord();if(w)document.querySelectorAll('.item[data-n="'+w.num+'"][data-d="'+dir+'"]').forEach(e=>e.classList.add('act'))
}

function getWC(r,c){
    const cells=[];
    if(dir==='across'){let sc=c;while(sc>0&&grid[r][sc-1])sc--;let ec=c;while(ec<SIZE-1&&grid[r][ec+1])ec++;for(let x=sc;x<=ec;x++)cells.push({r,c:x})}
    else{let sr=r;while(sr>0&&grid[sr-1][c])sr--;let er=r;while(er<SIZE-1&&grid[er+1][c])er++;for(let y=sr;y<=er;y++)cells.push({r:y,c})}
    return cells
}

function getCurWord(){
    if(!cur)return null;
    return placed.find(w=>{if(w.dir!==dir)return false;if(dir==='across')return w.row===cur.r&&cur.c>=w.col&&cur.c<w.col+w.word.length;return w.col===cur.c&&cur.r>=w.row&&cur.r<w.row+w.word.length})
}

function updClue(){
    const w=getCurWord();
    const ne=document.getElementById('cn'),te=document.getElementById('ct'),ke=document.getElementById('ck'),h2e=document.getElementById('ch2');
    if(w&&ne&&te){
        ne.textContent=w.num+' '+dir.toUpperCase();te.textContent=w.clue;if(ke)ke.textContent=w.kr;
        const wKey=w.num+'-'+w.dir;
        if(h2e){if(hint2Shown[wKey]&&w.hint2){h2e.textContent='üí° '+w.hint2;h2e.classList.add('on')}else{h2e.classList.remove('on')}}
    }
}

function startTmr(){
    stopTmr();
    tmr=setInterval(()=>{
        if(gameOver)return;
        sec++;
        const m=Math.floor(sec/60),s=sec%60;
        const timeEl=document.getElementById('time');
        timeEl.textContent=(m<10?'0':'')+m+':'+(s<10?'0':'')+s;

        // ÏãúÍ∞Ñ Ìå®ÎÑêÌã∞ (3Î∂Ñ Ï¥àÍ≥º ÌõÑ 10Ï¥àÎßàÎã§ -1Ï†ê)
        if(sec>=TIME_PENALTY_START){
            timeEl.classList.add('time-warn');
            if(!timePenaltyStarted){
                timePenaltyStarted=true;
                toast('‚ö†Ô∏è 3Î∂Ñ Ï¥àÍ≥º! 10Ï¥àÎßàÎã§ -1Ï†ê',false,true);
            }
            if((sec-TIME_PENALTY_START)%TIME_PENALTY_INTERVAL===0&&sec>TIME_PENALTY_START){
                updateScore(-TIME_PENALTY_AMOUNT);
            }
        }
    },1000)
}

function stopTmr(){if(tmr){clearInterval(tmr);tmr=null}}

function useHint1(){
    if(gameOver)return;
    if(score<SCORE.hintRandom){toast('Ï†êÏàòÍ∞Ä Î∂ÄÏ°±Ìï¥Ïöî!',false,true);return}
    const w=getCurWord();
    if(!w){toast('Îã®Ïñ¥Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî');return}
    const emp=[];
    for(let i=0;i<w.word.length;i++){
        const r=w.dir==='across'?w.row:w.row+i;
        const c=w.dir==='across'?w.col+i:w.col;
        if(!user[r][c]&&!isLocked(r,c))emp.push({r,c,letter:w.word[i]})
    }
    if(!emp.length){toast('Ïù¥ Îã®Ïñ¥Îäî Î™®Îëê Ï±ÑÏõåÏ°åÏñ¥Ïöî!');return}
    const{r,c,letter}=emp[Math.floor(Math.random()*emp.length)];
    user[r][c]=letter;locked.push({r,c});
    const e=document.getElementById('l-'+r+'-'+c);
    const cell=document.querySelector('.cell[data-r="'+r+'"][data-c="'+c+'"]');
    if(e)e.textContent=letter;
    if(cell){cell.classList.add('locked','ok')}
    updateScore(-SCORE.hintRandom);
    toast('üîÄ -'+SCORE.hintRandom+'Ï†ê (ÎûúÎç§ Í∏ÄÏûê)')
}

function useHint2(){
    if(gameOver)return;
    if(score<SCORE.hintEasy){toast('Ï†êÏàòÍ∞Ä Î∂ÄÏ°±Ìï¥Ïöî!',false,true);return}
    const w=getCurWord();
    if(!w){toast('Îã®Ïñ¥Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî');return}
    const wKey=w.num+'-'+w.dir;
    if(hint2Shown[wKey]){showHintPopup(w.hint2||w.kr);return}
    if(!w.hint2){toast('Ïâ¨Ïö¥ ÌûåÌä∏Í∞Ä ÏóÜÏñ¥Ïöî');return}
    hint2Shown[wKey]=true;
    updateScore(-SCORE.hintEasy);
    showHintPopup(w.hint2);
    updClue();
    toast('üí° -'+SCORE.hintEasy+'Ï†ê')
}

function useHint3(){
    if(gameOver)return;
    if(score<SCORE.hintAnswer){toast('Ï†êÏàòÍ∞Ä Î∂ÄÏ°±Ìï¥Ïöî!',false,true);return}
    const w=getCurWord();
    if(!w){toast('Îã®Ïñ¥Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî');return}
    const wKey=w.num+'-'+w.dir;
    if(revealedWords[wKey]){toast('Ïù¥ÎØ∏ Í≥µÍ∞úÎêú Îã®Ïñ¥ÏóêÏöî');return}
    revealedWords[wKey]=true;
    updateScore(-SCORE.hintAnswer);
    if(score<=0)return; // Í≤åÏûÑÏò§Î≤Ñ Ï≤¥ÌÅ¨
    for(let i=0;i<w.word.length;i++){
        const r=w.dir==='across'?w.row:w.row+i;
        const c=w.dir==='across'?w.col+i:w.col;
        if(!isLocked(r,c)){
            user[r][c]=w.word[i];locked.push({r,c});
            const e=document.getElementById('l-'+r+'-'+c);
            const cell=document.querySelector('.cell[data-r="'+r+'"][data-c="'+c+'"]');
            if(e)e.textContent=w.word[i];
            if(cell)cell.classList.add('locked','ok')
        }
    }
    const answerText=w.hint3||w.word;
    showHintPopup('Ï†ïÎãµ: '+answerText,'üîì Ï†ïÎãµ Í≥µÍ∞ú');
    toast('üîì -'+SCORE.hintAnswer+'Ï†ê')
}

function showHintPopup(text,label='Ïâ¨Ïö¥ ÌûåÌä∏'){
    const popup=document.getElementById('hintPopup');
    const content=document.getElementById('hintContent');
    popup.querySelector('.label').textContent=label;
    content.textContent=text;
    popup.classList.add('on');
    setTimeout(()=>hideHintPopup(),3000)
}

function hideHintPopup(){document.getElementById('hintPopup').classList.remove('on')}

function chk(){
    if(gameOver)return;
    let newCorrect=0,newWrong=0,wordsCompleted=0;
    for(let r=0;r<SIZE;r++)for(let c=0;c<SIZE;c++)if(grid[r][c]){
        const cell=document.querySelector('.cell[data-r="'+r+'"][data-c="'+c+'"]');
        if(isLocked(r,c))continue;
        cell.classList.remove('ok','err');
        if(user[r][c].toUpperCase()===grid[r][c]){
            newCorrect++;
            cell.classList.add('ok','locked');
            locked.push({r,c});
       }else if(user[r][c]){
           newWrong++;
           cell.classList.add('err');
           user[r][c]='';  // ÌãÄÎ¶∞ Í∏ÄÏûê Îç∞Ïù¥ÌÑ∞ ÏßÄÏö∞Í∏∞
           document.getElementById('l-'+r+'-'+c).textContent='';  // ÌôîÎ©¥ÏóêÏÑúÎèÑ ÏßÄÏö∞Í∏∞
       }
    }
    placed.forEach(w=>{
        const wKey=w.num+'-'+w.dir;
        if(revealedWords[wKey]||wordScored[wKey])return;
        let complete=true;
        for(let i=0;i<w.word.length;i++){
            const r=w.dir==='across'?w.row:w.row+i;
            const c=w.dir==='across'?w.col+i:w.col;
            if(user[r][c].toUpperCase()!==w.word[i])complete=false
        }
        if(complete){wordScored[wKey]=true;wordsCompleted++}
    });
    let gained=newCorrect*SCORE.letterCorrect+wordsCompleted*SCORE.wordComplete;
    let lost=newWrong*Math.abs(SCORE.letterWrong);
    let net=gained-lost;
    let total=0,correct=0;
    for(let r=0;r<SIZE;r++)for(let c=0;c<SIZE;c++)if(grid[r][c]){total++;if(user[r][c].toUpperCase()===grid[r][c])correct++}
    if(correct===total){
        net+=SCORE.puzzleClear;
        updateScore(net);
        stopTmr();
        toast('üéâ Round '+round+' ÌÅ¥Î¶¨Ïñ¥! +'+net+'Ï†ê',true);
        setTimeout(nextRound,2000)
    }else if(net>0){
        updateScore(net);
        toast('+'+net+'Ï†ê! ('+correct+'/'+total+')'+(newWrong>0?' ‚ùå'+newWrong:''))
    }else if(net<0){
        updateScore(net);
        toast(net+'Ï†ê üò± ('+correct+'/'+total+')',false,true)
    }else{
        if(newWrong>0)toast('¬±0Ï†ê (ÎßûÏùå +'+newCorrect+' / ÌãÄÎ¶º -'+newWrong+')');
        else toast(correct+'/'+total+' Ï†ïÎãµ')
    }
}

function showPanel(){document.getElementById('ov').classList.add('on');document.getElementById('pn').classList.add('on')}
function hidePanel(){document.getElementById('ov').classList.remove('on');document.getElementById('pn').classList.remove('on')}

function toggleKr(){
    krOn=!krOn;
    document.getElementById('tgl').classList.toggle('on',krOn);
    document.querySelectorAll('.kr').forEach(e=>e.classList.toggle('hide',!krOn));
    document.querySelectorAll('.clue-kr').forEach(e=>e.classList.toggle('on',krOn))
}

function togKrQ(){
    krOn=!krOn;
    document.querySelectorAll('.kr').forEach(e=>e.classList.toggle('hide',!krOn));
    document.querySelectorAll('.clue-kr').forEach(e=>e.classList.toggle('on',krOn));
    document.querySelectorAll('.toggle').forEach(e=>e.classList.toggle('on',krOn));
    const btn=document.getElementById('kb-btn');if(btn)btn.classList.toggle('on',krOn)
}

function toast(msg,ok=false,warn=false){
    const t=document.getElementById('toast');
    t.textContent=msg;
    t.classList.remove('ok','warn');
    if(ok)t.classList.add('ok');
    if(warn)t.classList.add('warn');
    t.classList.add('on');
    setTimeout(()=>t.classList.remove('on'),2000)
}

init();
    </script>
</body>
</html>
