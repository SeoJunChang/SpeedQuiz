<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
	<title>ìŠ¤í”¼ë“œ í€´ì¦ˆ: ë¯¸ì¹œ ëª¨ë“œ</title>
	<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js" defer></script>
	<style>
		*{margin:0;padding:0;box-sizing:border-box}
		:root{--bg:#0f172a;--bg2:#1e293b;--bg3:#334155;--accent:#3b82f6;--gold:#fbbf24;--error:#ef4444;--success:#22c55e;--crazy:#ff4757}
		body{font-family:'Apple SD Gothic Neo',sans-serif;background:var(--bg);color:#fff;height:100vh;display:flex;justify-content:center}
		.app{width:100%;max-width:500px;display:flex;flex-direction:column;padding:20px}
		header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
		.cat-badge{display:inline-block;padding:4px 10px;background:var(--accent);border-radius:20px;font-size:12px;margin-bottom:10px}
		.progress-container{width:100%;height:6px;background:#334155;border-radius:3px;overflow:hidden;margin-bottom:20px}
		.timer-bar{width:100%;height:100%;background:linear-gradient(to right, #3b82f6, #fbbf24);transition:width 0.1s linear}
		.game-card{background:var(--bg2);border-radius:20px;padding:30px;flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;position:relative;box-shadow:0 10px 25px rgba(0,0,0,0.3)}
		
		.cat-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
			gap: 10px; width: 100%; margin-top: 20px;
			max-height: 50vh; overflow-y: auto; padding: 5px;
			-webkit-overflow-scrolling: touch;
		}
		
		.btn-cat {
			padding: 15px 10px; border: none; border-radius: 15px; background: var(--accent);
			color: #fff; font-weight: bold; font-size: 16px; cursor: pointer; min-height: 54px;
			display: flex; align-items: center; justify-content: center;
		}
		.btn-crazy { background: var(--crazy) !important; grid-column: 1 / -1; font-size: 18px !important; }

		.question{font-size:24px; font-weight:bold; margin-bottom:30px; line-height:1.4; word-break: keep-all;}
		.answer-input{width:100%; background:var(--bg3); border:2px solid transparent; padding:15px; border-radius:12px; color:#fff; font-size:24px; text-align:center; outline:none}
		.answer-input:focus{border-color:var(--accent)}
		
		.result-overlay{position:fixed; inset:0; background:var(--bg); display:none; flex-direction:column; align-items:center; justify-content:center; z-index:100; padding:20px; overflow-y: auto;}
		.result-overlay.on{display:flex}
		
		.grade-badge {
			font-size: 80px; font-weight: 900; margin: 10px 0;
			text-shadow: 0 0 20px rgba(255,255,255,0.3);
		}
		.grade-S { color: var(--crazy); }
		.grade-A { color: var(--gold); }
		.grade-B { color: var(--success); }
		.grade-C { color: #888; }

		.btn-main{padding:15px 40px; border:none; border-radius:30px; background:var(--accent); color:#fff; font-weight:bold; font-size:18px; cursor:pointer; margin-top:15px; width: 100%; max-width: 300px;}
		.btn-share { background: #44bd32 !important; }

		#hint { min-height: 20px; color: var(--gold); font-size: 14px; margin-top: 20px; }
	</style>
</head>
<body>
	<div class="app">
		<header>
			<div id="status">ì—°ê²° ì‹œë„ ì¤‘...</div>
			<div>ì ìˆ˜: <span id="score">0</span></div>
		</header>
		<div class="progress-container"><div id="timerBar" class="timer-bar" style="width:0%"></div></div>
		
		<div id="startScreen" class="game-card">
			<h2 id="welcomeMsg">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</h2>
			<div id="categoryButtons" class="cat-grid"></div>
		</div>

		<div id="gameScreen" class="game-card" style="display:none">
			<div id="catBadge" class="cat-badge">ì¹´í…Œê³ ë¦¬</div>
			<div id="question" class="question"></div>
			<input type="text" id="answerInput" class="answer-input" placeholder="ì •ë‹µ ì…ë ¥" autocomplete="off">
			<div id="hint"></div>
		</div>
	</div>

	<div id="resultOverlay" class="result-overlay">
		<div id="captureArea" style="padding: 30px; background: var(--bg2); border-radius: 20px; text-align: center; width: 100%; max-width: 400px;">
			<h2 style="font-size: 20px; opacity: 0.8;">QUIZ RESULT</h2>
			<div id="gradeBadge" class="grade-badge">-</div>
			<div id="gradeText" style="font-size: 18px; color: var(--gold); margin-bottom: 20px; font-weight: bold;"></div>
			<div style="font-size: 44px; font-weight: 900; margin-bottom: 20px;"><span id="finalScoreDisplay">0</span></div>
			<div id="resultStats" style="text-align: left; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; line-height: 1.8; font-size: 14px;"></div>
		</div>
		<button class="btn-main btn-share" onclick="shareResult()">ğŸ–¼ï¸ ê²°ê³¼ ì´ë¯¸ì§€ ì €ì¥</button>
		<button class="btn-main" onclick="location.reload()">ë‹¤ì‹œ ì‹œì‘</button>
	</div>

	<script>
		// êµ¬ê¸€ ì‹œíŠ¸ URL (ë°˜ë“œì‹œ CSV í˜•ì‹)
		const SHEET_URL = `https://docs.google.com/spreadsheets/d/e/2PACX-1vQwOeULvb3hcqNCTNHmUEU7bqeDPvoPs96ue-e6yAmb1t80o9SvX4bO-JK6Rw-il9vYhdKBtdvf4z5B/pub?output=csv`;

		let allData = [];
		let gameItems = [];
		let curIdx = 0, score = 0, correctCount = 0, wrongCount = 0;
		let totalTimeTaken = 0, questionStartTime = 0;
		let timeLeft = 100, timerInterval = null, isProcessing = false;
		let isCrazyMode = false;
		let currentLimit = 10;

		async function loadData() {
			const status = document.getElementById('status');
			const welcome = document.getElementById('welcomeMsg');
			
			try {
				const response = await fetch(`${SHEET_URL}&t=${new Date().getTime()}`);
				if (!response.ok) throw new Error('Network error');
				
				const csvText = await response.text();
				const rows = csvText.split(/\r?\n/).filter(r => r.trim()).map(row => row.split(','));
				
				allData = rows.slice(1).map(row => {
					const clean = (val) => val ? val.replace(/^"|"$/g, '').trim() : '';
					return { word: clean(row[0]), clue: clean(row[1]), direct: clean(row[2]), cat: clean(row[3]) };
				}).filter(item => item.word && item.cat && item.cat !== 'MZì‹ ì¡°ì–´');

				const categories = [...new Set(allData.map(d => d.cat))];
				
				if(categories.length > 0) {
					renderButtons(categories);
					welcome.textContent = "ë¶„ì•¼ë¥¼ ì„ íƒí•˜ì„¸ìš”";
					status.textContent = "ì¤€ë¹„ ì™„ë£Œ";
				} else {
					throw new Error('No categories found');
				}
			} catch (e) {
				welcome.textContent = "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
				status.textContent = "ì—°ê²° ì‹¤íŒ¨";
				console.error(e);
			}
		}

		function renderButtons(categories) {
			const container = document.getElementById('categoryButtons');
			container.innerHTML = '';
			
			const crazyBtn = document.createElement('button');
			crazyBtn.className = 'btn-cat btn-crazy';
			crazyBtn.textContent = 'ğŸ”¥ ì¢…í•© ë¬¸ì œ (ë¯¸ì¹œ ëª¨ë“œ)';
			crazyBtn.onclick = () => startGame('CRAZY');
			container.appendChild(crazyBtn);

			categories.forEach(cat => {
				const btn = document.createElement('button');
				btn.className = 'btn-cat';
				btn.textContent = cat;
				btn.onclick = () => startGame(cat);
				container.appendChild(btn);
			});
		}

		function startGame(cat) {
			if(cat === 'CRAZY') {
				isCrazyMode = true;
				currentLimit = 5;
				gameItems = allData.sort(() => Math.random() - 0.5).slice(0, 20);
			} else {
				isCrazyMode = false;
				currentLimit = 10;
				gameItems = allData.filter(d => d.cat === cat).sort(() => Math.random() - 0.5).slice(0, 12);
			}
			document.getElementById('startScreen').style.display = 'none';
			document.getElementById('gameScreen').style.display = 'flex';
			startQuest();
		}

		function startQuest() {
			if(curIdx >= gameItems.length) return endGame();
			isProcessing = false;
			wrongCount = 0;
			const item = gameItems[curIdx];

			cBadge.textContent = isCrazyMode ? `ğŸ”¥ ì¢…í•© [${item.cat}]` : item.cat;
			qText.textContent = item.clue;
			hText.textContent = ""; 
			document.getElementById('status').textContent = `${curIdx + 1} / ${gameItems.length}`;

			document.getElementById('answerInput').blur();
			document.getElementById('answerInput').value = '';
			setTimeout(() => { document.getElementById('answerInput').focus(); }, 150);
			
			questionStartTime = Date.now();
			startTimer();
		}

		aInput.addEventListener('input', () => {
			if(!isProcessing && aInput.value.trim() === gameItems[curIdx].word) processCorrect();
		});

		aInput.addEventListener('keydown', (e) => {
			if(e.key === 'Enter' && !isProcessing) {
				if(aInput.value.trim() === gameItems[curIdx].word) {
					processCorrect();
				} else {
					wrongCount++;
					aInput.style.borderColor = "var(--error)";
					if(wrongCount === 1) hText.textContent = `ğŸ’¡ íŒíŠ¸: ${gameItems[curIdx].direct}`;
					setTimeout(() => { aInput.style.borderColor = "transparent"; }, 500);
				}
			}
		});

		function startTimer() {
			timeLeft = 100;
			if(timerInterval) clearInterval(timerInterval);
			timerInterval = setInterval(() => {
				timeLeft -= (10 / currentLimit);
				tBar.style.width = timeLeft + "%";
				if(timeLeft <= 0) {
					totalTimeTaken += currentLimit;
					processWrong();
				}
			}, 100);
		}

		function processCorrect() {
			isProcessing = true;
			clearInterval(timerInterval);
			totalTimeTaken += (Date.now() - questionStartTime) / 1000;
			correctCount++;
			score += Math.max(10, Math.ceil(timeLeft)) * (isCrazyMode ? 2 : 1);
			document.getElementById('score').textContent = score;
			aInput.style.borderColor = "var(--success)";
			setTimeout(() => { curIdx++; startQuest(); }, 400);
		}

		function processWrong() {
			isProcessing = true;
			clearInterval(timerInterval);
			aInput.style.borderColor = "var(--error)";
			qText.innerHTML = `<span style="color:var(--error)">ì‹œê°„ ì´ˆê³¼!</span><br>ì •ë‹µ: ${gameItems[curIdx].word}`;
			setTimeout(() => { curIdx++; startQuest(); }, 1500);
		}

		function endGame() {
			document.getElementById('resultOverlay').classList.add('on');
			const avgSpeed = (totalTimeTaken / gameItems.length).toFixed(2);
			const accuracy = Math.round((correctCount / gameItems.length) * 100);
			document.getElementById('finalScoreDisplay').textContent = score + "ì ";
			
			let grade = 'C', comment = 'ë¶„ë°œí•˜ì„¸ìš”!';
			if (isCrazyMode) {
				if (score >= 1800) { grade = 'S'; comment = 'ë¯¸ì¹œ ìˆœë°œë ¥! ì‹ ì˜ ê²½ì§€!'; }
				else if (score >= 1200) { grade = 'A'; comment = 'ëŒ€ë‹¨í•´ìš”! ê´‘ê¸° ì–´ë¦° ì†ë„!'; }
				else if (score >= 700) { grade = 'B'; comment = 'ë‚˜ì˜ì§€ ì•Šì•„ìš”!'; }
			} else {
				if (score >= 1000) { grade = 'S'; comment = 'ì™„ë²½í•©ë‹ˆë‹¤! í€´ì¦ˆ ë§ˆìŠ¤í„°!'; }
				else if (score >= 700) { grade = 'A'; comment = 'í›Œë¥­í•´ìš”! ë›°ì–´ë‚œ ì‹¤ë ¥!'; }
				else if (score >= 400) { grade = 'B'; comment = 'ë‚˜ì˜ì§€ ì•Šë„¤ìš”!'; }
			}

			const gBadge = document.getElementById('gradeBadge');
			gBadge.textContent = grade;
			gBadge.className = `grade-badge grade-${grade}`;
			document.getElementById('gradeText').textContent = comment;

			document.getElementById('resultStats').innerHTML = `
				ğŸ¯ ì •ë‹µë¥ : <b>${accuracy}%</b> (${correctCount}/${gameItems.length})<br>
				âš¡ í‰ê·  ì†ë„: <b>${avgSpeed}ì´ˆ</b><br>
				ğŸ”¥ ëª¨ë“œ: <b>${isCrazyMode ? 'ë¯¸ì¹œ ëª¨ë“œ' : 'ì¼ë°˜ ëª¨ë“œ'}</b>
			`;
		}

		function shareResult() {
			if(typeof html2canvas === 'undefined') {
				alert("ì´ë¯¸ì§€ ìƒì„± ë„êµ¬ê°€ ì•„ì§ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
				return;
			}
			html2canvas(document.getElementById('captureArea'), { backgroundColor: "#1e293b" }).then(canvas => {
				const link = document.createElement('a');
				link.download = `Quiz_Result.png`;
				link.href = canvas.toDataURL();
				link.click();
			});
		}

		window.onload = loadData;
	</script>
</body>
</html>
